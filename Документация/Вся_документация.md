# Мобильный мессенджер "QuickChat"

## Содержание
1. [Бизнес-требования](#бизнес-требования)
2. [План тестирования](#план-тестирования)
3. [Пользовательские истории](#пользовательские-истории)
4. [Use Case сценарии](#use-case-сценарии)
5. [Системный анализ](#системный-анализ)
6. [Архитектура](#архитектура)
7. [API спецификация](#api-спецификация)

---

## Бизнес-требования

### 1.1. Общее описание
**Название проекта:** QuickChat - современный мобильный мессенджер

**Цель проекта:** Создать безопасный, высокопроизводительный мессенджер с расширенными функциями коммуникации для личного и группового общения.

**Бизнес-проблема:** Отсутствие единого мобильного решения, сочетающего простоту личных сообщений, мощь групповых голосовых каналов и богатые медиа-возможности.

**Целевая аудитория:**
- Пользователи 18-35 лет
- Игровые сообщества
- Учебные группы
- Удаленные команды
- Социальные группы по интересам

### 1.2. Бизнес-цели
| ID   | Цель | Приоритет | Метрика успеха |
|------|------|-----------|----------------|
| BG-1 | Привлечь 100K активных пользователей за 6 месяцев | Высокий | MAU > 100K |
| BG-2 | Обеспечить среднее время сессии > 15 минут | Высокий | Avg. session time > 15min |
| BG-3 | Достичь retention rate 40% на 30-й день | Средний | Retention 30d > 40% |
| BG-4 | Поддержка iOS и Android | Высокий | 99% uptime |

### 1.3. Функциональные требования

#### Модуль 1: Обмен сообщениями
- **FR-1.1:** Отправка и получение текстовых сообщений в реальном времени
- **FR-1.2:** Поддержка эмодзи, стикеров и GIF
- **FR-1.3:** Удаление сообщений для себя и для всех участников
- **FR-1.4:** Редактирование отправленных сообщений
- **FR-1.5:** Ответ на конкретное сообщение (reply)
- **FR-1.6:** Цитирование сообщений
- **FR-1.7:** Индикаторы прочтения (галочки)

#### Модуль 2: Медиа-контент
- **FR-2.1:** Отправка и получение фотографий с возможностью сжатия
- **FR-2.2:** Отправка и получение видео до 100МБ
- **FR-2.3:** Отправка аудио-сообщений с записью "на лету"
- **FR-2.4:** Просмотр медиа в галерее чата
- **FR-2.5:** Предпросмотр ссылок (link preview)
- **FR-2.6:** Отправка файлов до 50МБ

#### Модуль 3: Голосовые звонки
- **FR-3.1:** Групповые голосовые звонки до 50 участников
- **FR-3.2:** Создание постоянных голосовых каналов
- **FR-3.3:** Включение/выключение микрофона во время звонка
- **FR-3.4:** Переключение между динамиком и наушниками
- **FR-3.5:** Индикатор активности говорящего
- **FR-3.6:** Приглашение участников в голосовой канал
- **FR-3.7:** Настройки качества звука (low/medium/high)

#### Модуль 4: Управление чатами
- **FR-4.1:** Создание личных чатов (1 на 1)
- **FR-4.2:** Создание групповых чатов до 500 участников
- **FR-4.3:** Поиск по истории сообщений
- **FR-4.4:** Закрепление важных сообщений
- **FR-4.5:** Архивирование чатов
- **FR-4.6:** Настройка уведомлений для каждого чата
- **FR-4.7:** Черный список пользователей

#### Модуль 5: Профиль и безопасность
- **FR-5.1:** Регистрация по номеру телефона
- **FR-5.2:** Двухфакторная аутентификация
- **FR-5.3:** Сквозное шифрование сообщений
- **FR-5.4:** Самоуничтожающиеся сообщения
- **FR-5.5:** Резервное копирование в облако
- **FR-5.6:** История активных сессий

### 1.4. Нефункциональные требования
- **NFR-1 (Производительность):** Время отправки сообщения < 100мс, 99-й перцентиль
- **NFR-2 (Безопасность):** TLS 1.3, сквозное шифрование Signal Protocol
- **NFR-3 (Масштабируемость):** Поддержка 1M+ одновременных подключений
- **NFR-4 (Юзабилити):** Time to First Message < 3 секунд
- **NFR-5 (Надежность):** 99.9% доступности, автоматическое восстановление
- **NFR-6 (Совместимость):** iOS 13+, Android 8.0+
- **NFR-7 (Батарея):** Фоновая работа < 2% батареи/час

---

## План тестирования

### 2.1. Типы тестирования
- Функциональное тестирование
- Интеграционное тестирование
- Нагрузочное тестирование (до 10K одновременных пользователей)
- Тестирование безопасности (пентест)
- Тестирование совместимости (разные устройства, версии ОС)
- Юзабилити-тестирование
- Тестирование восстановления после сбоев

### 2.2. Автоматизация тестирования
#### Unit-тесты
- Покрытие кода > 80%
- Тестирование бизнес-логики
- Тестирование утилитных функций

#### Интеграционные тесты
- Тестирование API endpoints
- Тестирование WebSocket соединений
- Тестирование работы с базой данных

#### UI-тесты
- Автоматизация основных сценариев
- Скриншот-тестирование
- Тестирование жестов и анимаций

### 2.3. Критерии начала тестирования
- Завершен спринт разработки
- Выполнено код-ревью
- Пройдены все unit-тесты
- Собрана альфа-версия сборки

### 2.4. Критерии приемки
- Нет критических багов (Blocker, Critical)
- Все высокоприоритетные требования реализованы
- Производительность соответствует NFR
- Успешно пройдены тесты безопасности

### 2.5. График тестирования
| Этап | Спринт | Дата | Ответственный |
|------|--------|------|---------------|
| Smoke-тестирование | Каждый спринт | Еженедельно | QA Engineer |
| Регрессионное тестирование | Спринт 4 | 01.11.2024 | QA Team |
| Нагрузочное тестирование | Спринт 6 | 15.12.2024 | DevOps |
| User Acceptance Testing | Спринт 8 | 31.01.2025 | Product Owner |
| Пентест | Перед релизом | 15.02.2025 | Security Team |

---

## Пользовательские истории

### 3.1. Роли
- **Гость:** Неавторизованный пользователь
- **Пользователь:** Зарегистрированный пользователь
- **Администратор группы:** Создатель/админ группы
- **Модератор:** Назначенный модератор чата

### 3.2. Бэклог продукта

#### Epic 1: Базовая мессенджер-функциональность
**US-1.1:** Как пользователь, я хочу отправлять и получать текстовые сообщения, чтобы общаться с друзьями
- **Критерии приемки:**
  1. Сообщение отправляется при нажатии кнопки "Отправить"
  2. Сообщение отображается у получателя в реальном времени
  3. Показываются индикаторы отправки/доставки/прочтения
  4. Поддерживается отправка эмодзи через нативную клавиатуру
- **Story Points:** 5
- **Приоритет:** Высокий

**US-1.2:** Как пользователь, я хочу удалять отправленные сообщения, чтобы исправить ошибки или скрыть информацию
- **Критерии приемки:**
  1. При долгом нажатии на сообщение появляется меню с опцией "Удалить"
  2. Можно выбрать "Удалить для меня" или "Удалить для всех"
  3. При удалении для всех сообщение исчезает у всех участников
  4. Система показывает уведомление о удаленном сообщении
- **Story Points:** 8
- **Приоритет:** Высокий

#### Epic 2: Медиа-обмен
**US-2.1:** Как пользователь, я хочу отправлять фотографии и видео, чтобы делиться моментами
- **Критерии приемки:**
  1. Есть кнопка "+" для доступа к медиа-функциям
  2. Можно выбрать фото из галереи или сделать новое
  3. Для видео доступен предпросмотр перед отправкой
  4. Показывается прогресс загрузки
  5. Полученные медиа можно открыть на весь экран
- **Story Points:** 13
- **Приоритет:** Высокий

**US-2.2:** Как пользователь, я хочу отправлять голосовые сообщения, чтобы быстро общаться
- **Критерии приемки:**
  1. При удержании кнопки микрофона начинается запись
  2. Показывается визуализация звука во время записи
  3. Можно прослушать запись перед отправкой
  4. Есть возможность отменить запись свайпом
  5. Полученные голосовые сообщения воспроизводятся автоматически при поднесении к уху
- **Story Points:** 8
- **Приоритет:** Средний

#### Epic 3: Голосовые каналы
**US-3.1:** Как администратор группы, я хочу создать голосовой канал, чтобы участники могли общаться голосом
- **Критерии приемки:**
  1. В настройках группы есть опция "Создать голосовой канал"
  2. Можно задать название канала и ограничить количество участников
  3. Канал отображается в списке каналов группы
  4. Участники могут заходить и выходить из канала в любое время
- **Story Points:** 13
- **Приоритет:** Высокий

**US-3.2:** Как пользователь, я хочу участвовать в групповом звонке, чтобы обсуждать темы с несколькими людьми
- **Критерии приемки:**
  1. В голосовом канале отображается список участников
  2. Можно включить/выключить микрофон во время звонка
  3. Есть индикатор, кто говорит в данный момент
  4. Поддерживается минимум 10 участников одновременно
  5. Качество связи стабильное при скорости интернета > 1Мбит/с
- **Story Points:** 21
- **Приоритет:** Высокий

#### Epic 4: Управление контактами и чатами
**US-4.1:** Как пользователь, я хочу создать групповой чат, чтобы общаться с несколькими людьми одновременно
- **Критерии приемки:**
  1. В меню "Новый чат" есть опция "Новая группа"
  2. Можно добавить участников из списка контактов
  3. Можно задать название группы и фото
  4. Все участники получают уведомление о добавлении
- **Story Points:** 5
- **Приоритет:** Высокий

**US-4.2:** Как пользователь, я хочу искать по истории сообщений, чтобы найти нужную информацию
- **Критерии приемки:**
  1. В каждом чате есть поисковая строка
  2. Поиск работает по тексту сообщений
  3. Можно фильтровать результаты по типу (текст, фото, видео)
  4. Найденные сообщения выделяются в истории
- **Story Points:** 8
- **Приоритет:** Средний

#### Epic 5: Безопасность и приватность
**US-5.1:** Как пользователь, я хочу включить двухфакторную аутентификацию, чтобы защитить свой аккаунт
- **Критерии приемки:**
  1. В настройках безопасности есть опция "2FA"
  2. Можно привязать Google Authenticator или получить SMS
  3. При входе с нового устройства запрашивается код
  4. Можно сгенерировать резервные коды
- **Story Points:** 13
- **Приоритет:** Средний

**US-5.2:** Как пользователь, я хочу отправлять самоуничтожающиеся сообщения для конфиденциальной информации
- **Критерии приемки:**
  1. При отправке сообщения можно установить таймер (10сек-24часа)
  2. Получатель видит таймер на сообщении
  3. После истечения времени сообщение удаляется у всех
  4. Получатель не может сделать скриншот (определяется система)
- **Story Points:** 13
- **Приоритет:** Низкий

## 4.2. Детализация Use Case

### UC-1: Удаление сообщения
**Акторы:** Пользователь  
**Предусловия:** Пользователь авторизован, сообщение отправлено  
**Основной поток:**
1. Пользователь долго нажимает на свое сообщение
2. Система показывает контекстное меню
3. Пользователь выбирает "Удалить"
4. Система спрашивает "Удалить для себя или для всех?"
5. Пользователь выбирает "Удалить для всех"
6. Система удаляет сообщение у всех участников
7. Система показывает уведомление "Сообщение удалено"  

**Постусловия:** Сообщение удалено из БД и у всех клиентов  
**Исключения:**
- **E1:** Нет подключения к интернету → Кэширование операции
- **E2:** Прошло больше 24 часов → Можно удалить только для себя

---

### UC-2: Создание группового голосового звонка
**Акторы:** Пользователь, Участники  
**Предусловия:** Пользователь находится в групповом чате  
**Основной поток:**
1. Пользователь нажимает кнопку "Голосовой звонок" в чате
2. Система создает временный голосовой канал
3. Система отправляет уведомления всем участникам чата
4. Участники присоединяются к звонку
5. Пользователь управляет звонком (мут, выключение звука)
6. Последний участник выходит из звонка
7. Система автоматически закрывает канал  

**Постусловия:** Канал удален, запись звонка сохранена (если включено)  
**Исключения:**
- **E1:** Сервер перегружен → Ограничение количества участников
- **E2:** Участник теряет связь → Автоматическое переподключение

---

### UC-3: Отправка видео сообщения
**Акторы:** Пользователь, Получатель  
**Предусловия:** Пользователь в чате, есть доступ к камере  
**Основной поток:**
1. Пользователь нажимает кнопку "Видео"
2. Система запрашивает разрешение на доступ к камере
3. Пользователь записывает видео (макс. 60 секунд)
4. Пользователь просматривает и редактирует видео
5. Пользователь нажимает "Отправить"
6. Система сжимает видео и загружает на сервер
7. Получатель получает уведомление
8. Получатель просматривает видео  

**Постусловия:** Видео сохранено в облаке, миниатюра в чате  
**Исключения:**
- **E1:** Недостаточно места → Предложение очистки кэша
- **E2:** Плохое соединение → Автоматическое понижение качества

---

## 5. Системный анализ

### 5.1. Требования к системе

#### Клиентская часть (мобильное приложение)
- **Платформы:** iOS 13+, Android 8.0+
- **Архитектура:** MVVM для iOS, MVVM для Android
- **Языки:** Swift, Kotlin
- **Минимальные требования:**
  - iOS: iPhone 6s, 2GB RAM
  - Android: 2GB RAM, 1.5GHz процессор
- **Библиотеки:**
  - Сеть: Alamofire (iOS), Retrofit (Android)
  - WebSocket: Starscream (iOS), OkHttp (Android)
  - База данных: Realm
  - Медиа: FFmpeg для обработки видео

#### Серверная часть
- **Сервера:** Микросервисная архитектура
- **Языки:** Go (основной), Node.js (realtime)
- **Базы данных:**
  - Основная: PostgreSQL 14
  - Кэш: Redis 6
  - Сообщения: MongoDB 5 (для горизонтального масштабирования)
- **Брокер сообщений:** RabbitMQ
- **Хранение медиа:** AWS S3 / MinIO
- **Контейнеризация:** Docker, Kubernetes

#### Инфраструктура
- **CDN:** CloudFront для медиа-контента
- **Мониторинг:** Prometheus + Grafana
- **Логи:** ELK Stack
- **CI/CD:** GitLab CI
- **Пуш-уведомления:** Firebase Cloud Messaging, Apple Push Notification Service

### 5.2. Ограничения и зависимости
#### Внешние зависимости:
- Twilio/Vonage для VoIP (альтернатива: собственная реализация WebRTC)
- AWS/Azure для облачной инфраструктуры
- Sentry для мониторинга ошибок

#### Ограничения:
- Размер APK/IPA не более 50MB
- Использование памяти не более 300MB в фоне
- Потребление трафика не более 1MB/час в фоне

### 5.3. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Плохая связь у пользователей | Высокая | Высокое | Адаптивное качество, офлайн-режим |
| Высокая нагрузка на сервера | Средняя | Критическое | Автоскейлинг, кэширование |
| Утечка пользовательских данных | Низкая | Критическое | Шифрование, аудит доступа |
| Отклонение от магазинов приложений | Средняя | Высокое | Строгое следование гайдлайнам |

---

## 6. Архитектура

### 6.1. Высокоуровневая архитектура

| Уровень | Компонент | Технологии | Описание |
|---------|-----------|------------|----------|
| **Клиент** | iOS приложение | Swift, UIKit/SwiftUI | Нативное приложение для iPhone/iPad |
| **Клиент** | Android приложение | Kotlin, Jetpack Compose | Нативное приложение для Android |
| **Шлюз** | API Gateway | NGINX, SSL | Балансировка нагрузки, терминация SSL |
| **Сервисы** | Auth Service | Go, JWT | Аутентификация и авторизация |
| **Сервисы** | Messaging Service | Go, WebSocket | Обработка сообщений |
| **Сервисы** | Voice Service | Node.js, WebRTC | Голосовая связь |
| **Базы данных** | PostgreSQL | PostgreSQL 14 | Хранение пользовательских данных |
| **Базы данных** | MongoDB | MongoDB 5 | Хранение сообщений |
| **Кэш** | Redis | Redis 6 | Сессии, кэширование |

### 6.2. Компоненты системы

#### 6.2.1. Сервис аутентификации (Auth Service)
- Регистрация/авторизация
- Управление сессиями
- 2FA
- Токены JWT

#### 6.2.2. Сервис сообщений (Messaging Service)
- Обмен текстовыми сообщениями
- Маршрутизация сообщений
- Очереди доставки
- Офлайн-сообщения

#### 6.2.3. Сервис медиа (Media Service)
- Загрузка/скачивание файлов
- Конвертация и сжатие
- Генерация превью
- CDN интеграция

#### 6.2.4. Голосовой сервис (Voice Service)
- WebRTC сигналинг
- SFU (Selective Forwarding Unit) для групповых звонков
- Микширование аудио
- Запись звонков

#### 6.2.5. Сервис уведомлений (Notification Service)
- Пуш-уведомления
- Эмейл уведомления
- Настройки уведомлений пользователей

### 6.3. Поток данных

#### Отправка сообщения:
1. Клиент отправляет сообщение через WebSocket
2. API Gateway маршрутизирует к Messaging Service
3. Сообщение сохраняется в MongoDB
4. Сервис проверяет онлайн-статус получателя
5. Если онлайн → отправка через WebSocket
6. Если офлайн → помещение в очередь для пуш-уведомлений
7. Получатель подтверждает получение
8. Обновляются индикаторы прочтения

#### Групповой звонок:
1. Инициатор создает звонок через Voice Service
2. Сервис создает комнату WebRTC
3. Участникам отправляются приглашения
4. Участники подключаются к SFU
5. SFU оптимизирует трафик (выбор качества)
6. При выходе последнего участника комната закрывается
7. Метаданные звонка сохраняются

