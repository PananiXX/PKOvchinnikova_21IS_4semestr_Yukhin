## 6. Архитектура

### 6.1. Высокоуровневая архитектура

| Уровень | Компонент | Технологии | Описание |
|---------|-----------|------------|----------|
| **Клиент** | iOS приложение | Swift, UIKit/SwiftUI | Нативное приложение для iPhone/iPad |
| **Клиент** | Android приложение | Kotlin, Jetpack Compose | Нативное приложение для Android |
| **Шлюз** | API Gateway | NGINX, SSL | Балансировка нагрузки, терминация SSL |
| **Сервисы** | Auth Service | Go, JWT | Аутентификация и авторизация |
| **Сервисы** | Messaging Service | Go, WebSocket | Обработка сообщений |
| **Сервисы** | Voice Service | Node.js, WebRTC | Голосовая связь |
| **Базы данных** | PostgreSQL | PostgreSQL 14 | Хранение пользовательских данных |
| **Базы данных** | MongoDB | MongoDB 5 | Хранение сообщений |
| **Кэш** | Redis | Redis 6 | Сессии, кэширование |

### 6.2. Компоненты системы

#### 6.2.1. Сервис аутентификации (Auth Service)
- Регистрация/авторизация
- Управление сессиями
- 2FA
- Токены JWT

#### 6.2.2. Сервис сообщений (Messaging Service)
- Обмен текстовыми сообщениями
- Маршрутизация сообщений
- Очереди доставки
- Офлайн-сообщения

#### 6.2.3. Сервис медиа (Media Service)
- Загрузка/скачивание файлов
- Конвертация и сжатие
- Генерация превью
- CDN интеграция

#### 6.2.4. Голосовой сервис (Voice Service)
- WebRTC сигналинг
- SFU (Selective Forwarding Unit) для групповых звонков
- Микширование аудио
- Запись звонков

#### 6.2.5. Сервис уведомлений (Notification Service)
- Пуш-уведомления
- Эмейл уведомления
- Настройки уведомлений пользователей

### 6.3. Поток данных

#### Отправка сообщения:
1. Клиент отправляет сообщение через WebSocket
2. API Gateway маршрутизирует к Messaging Service
3. Сообщение сохраняется в MongoDB
4. Сервис проверяет онлайн-статус получателя
5. Если онлайн → отправка через WebSocket
6. Если офлайн → помещение в очередь для пуш-уведомлений
7. Получатель подтверждает получение
8. Обновляются индикаторы прочтения

#### Групповой звонок:
1. Инициатор создает звонок через Voice Service
2. Сервис создает комнату WebRTC
3. Участникам отправляются приглашения
4. Участники подключаются к SFU
5. SFU оптимизирует трафик (выбор качества)
6. При выходе последнего участника комната закрывается
7. Метаданные звонка сохраняются

